# Task Summary:
1.  Automatically monitor and rotate/delete large log files (e.g., NGINX and app logs) to prevent `/var` from filling up.
2.  We'll do the following:
    1.understand the log location and setup.
    2.create a script to check the log file sizes.
    3.Rotate or delete log based on file size.
    4.Set up a cron job to automate this rotation/deletion.


# Set up a Linux ENV
## 1.Create a Docker File.
```Dockerfile```
```bash
FROM ubuntu:22.04

RUN apt-get update && \
    apt-get install -y nginx cron gzip vim logrotate

# Create app log directory and dummy logs
RUN mkdir -p /home/devops/app/logs && \
    echo "Starting logs..." > /home/devops/app/logs/app.log

# Start shell on container run
CMD ["/bin/bash"]
```
    This will get a base image for linux environment , install required tools , set up fake app log directory , initialize a dummy app log file and starts an interactive terminal when container runs.

## 2.Build and run the container
1.  Build the image by `docker build -t devops-logs .`  
2.  Run a container from the image by `docker run -it --name logtest devops-logs`

# Directory Structure Inside the Container
```lua
/
├── var/
│   └── log/
│       ├── nginx/
│       │   ├── access.log
│       │   └── error.log
│       └── archived_logs/         <-- You'll create this for archived logs
├── home/
│   └── devops/
│       └── app/
│           └── logs/
│               └── app.log
```
# Monitor and rotate log
## Create a monitor and rotate log file ```monitor_and_rotate_logs.sh```
```bash
#!/bin/bash

THRESHOLD = 100
LOG_FILES = (
    "/var/log/nginx/access.log"
    "/home/devops/app/logs/app.log"
)

ARCHIVE_DIR = "/var/log/archived_logs"
mkdir -p "$ARCHIVE_DIR"

for LOG in "${LOG_FILES[@]}"; do
    if [-f "$LOG"]; then
        SIZE_MB = $(du -m "$LOG" | cut -f1)

        if ["SIZE_MB" -ge "$THRESHOLD"]; then
            TIMESTAMP=$(date +%Y%m%d%H%M%S)
            BASENAME=$(basename "$LOG")
            ARCHIVE_PATH="$ARCHIVE_DIR/${BASENAME}_${TIMESTAMP}.gz"

            echo "Rotating $LOG ($SIZE_MB MB)"

            cp "$LOG" "$LOG.old"
            gzip -c "$LOG.old" > "$ARCHIVE_PATH"
            rm -f "$LOG.old"
            cat /dev/null > "$LOG"
        fi
    fi
done
```
1.  Make it executable by `chmod +x /root/monitor_and_rotate_logs.sh`
2.  Then run it to test by `./root/monitor_and_rotate_logs.sh`

# Schedule it with cron
1.  open crontab file by ```crontab -e```
2.  Add cron job by ```*/5 * * * * /root/monitor_and_rotate_logs.sh >> /var/log/log_rotation.log 2>&1``` This command schedule the script to run every 5 minutes and Redirect output and errors to a log file.
3.  Save and exit 

# Summary:
1.  Docker Setup: Created a Docker container with Ubuntu 22.04 and tools like NGINX, cron, gzip, and logrotate.
2.  Log Rotation Script: A bash script was created to monitor and rotate logs based on size.
3.  Cron Job Automation: Set up a cron job to run the log rotation script periodically, automating the process.
```text
Every 5 minutes:
 └── Cron runs script
     └── Check log files
         ├── If > 100MB:
         │   ├── Copy it
         │   ├── Compress it (.gz)
         │   ├── Move to archive
         │   └── Empty original file
         └── If < 100MB: do nothing
```
